#!/bin/bash

main() {
  docker-compose up -d gridium

  trap bin/cleanup EXIT

  docker exec $(docker-compose ps -q gridium) bash -c "echo -e '---\n:rubygems_api_key: $1' >> ~/.gem/credentials; chmod 0600 ~/.gem/credentials; cat ~/.gem/credentials"
  docker exec $(docker-compose ps -q gridium) bash -c "gem build gridium.gemspec"
  docker exec $(docker-compose ps -q gridium) bash -c "gem push gridium-1.1.$BUILD_NUMBER.gem"
}

main $1
